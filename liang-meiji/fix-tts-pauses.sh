#!/bin/bash
# 全面修复TTS文本的断句和停顿问题
# 基于Copilot分析 + 手动分析 + Qwen验证

if [ $# -lt 1 ]; then
  echo "用法: $0 <tts-file>"
  echo "示例: $0 articles/11-胜海舟-tts.txt"
  exit 1
fi

FILE="$1"
BACKUP="$FILE.pause-fix-backup"

if [ ! -f "$FILE" ]; then
  echo "❌ 文件不存在: $FILE"
  exit 1
fi

# 备份
cp "$FILE" "$BACKUP"
echo "💾 原文备份: $BACKUP"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔧 TTS断句和停顿修复流程"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ==============================
# 第一步：删除人名保护顿号（最严重问题！）
# ==============================
echo "🚨 Step 1: 删除人名保护顿号（、人名、→ 人名）..."
sed -i '' \
  -e 's/、坂本龙马、/坂本龙马/g' \
  -e 's/、胜海舟、/胜海舟/g' \
  -e 's/、西乡隆盛、/西乡隆盛/g' \
  -e 's/、德川庆喜、/德川庆喜/g' \
  -e 's/、大久保利通、/大久保利通/g' \
  -e 's/、福泽谕吉、/福泽谕吉/g' \
  -e 's/、木户孝允、/木户孝允/g' \
  -e 's/、岩仓具视、/岩仓具视/g' \
  -e 's/、小栗忠顺、/小栗忠顺/g' \
  -e 's/、榎本武扬、/榎本武扬/g' \
  -e 's/、佐久间象山、/佐久间象山/g' \
  -e 's/、明治天皇、/明治天皇/g' \
  "$FILE"

# 通用规则：删除所有"、[2-4个汉字]、"模式（人名/专有名词）
sed -i '' -E 's/、([^、]{2,5})、/\1/g' "$FILE"

echo "   ✓ 人名顿号清理完成"

# ==============================
# 第二步：删除多音字标注括号
# ==============================
echo "🔧 Step 2: 删除多音字标注括号..."
sed -i '' -E 's/\([a-z0-9]+\)//g' "$FILE"
echo "   ✓ 多音字标注清理完成"

# ==============================
# 第三步：年份格式统一（日本年号用圆括号注释）
# ==============================
echo "🔧 Step 3: 年份格式统一..."
# 文久二年，1862年 → 1862年（文久二年）
sed -i '' \
  -e 's/文久二年，1862年/1862年，文久二年/g' \
  -e 's/嘉永六年，1853年/1853年，嘉永六年/g' \
  -e 's/万延元年，1860年/1860年，万延元年/g' \
  -e 's/元治元年，1864年/1864年，元治元年/g' \
  -e 's/庆应二年，1866年/1866年，庆应二年/g' \
  -e 's/庆应四年，1868年/1868年，庆应四年/g' \
  -e 's/明治三十二年，1899年/1899年，明治三十二年/g' \
  -e 's/明治十年，1877年/1877年，明治十年/g' \
  "$FILE"
echo "   ✓ 年份格式统一完成"

# ==============================
# 第四步：数字+量词分隔
# ==============================
echo "🔧 Step 4: 数字+量词添加顿号..."
sed -i '' \
  -e 's/\([0-9]\+\)个/\1、个/g' \
  -e 's/一百五十万人/一百五十万、人/g' \
  -e 's/一万多人/一万、多人/g' \
  -e 's/五千人/五千、人/g' \
  -e 's/三十多年/三十、多年/g' \
  -e 's/两个月/两、个月/g' \
  -e 's/两天/两、天/g' \
  -e 's/四个字/四、个字/g' \
  "$FILE"
echo "   ✓ 数字量词分隔完成"

# ==============================
# 第五步：超长句拆分（逗号改句号）
# ==============================
echo "🔧 Step 5: 超长句拆分..."
sed -i '' \
  -e 's/但你想过没有，这座城里/但你想过没有？这座城里/g' \
  -e 's/江户变成焦土，新政府/江户变成焦土。新政府/g' \
  -e 's/确实吓了一跳，这个人的见识/确实吓了一跳。这个人的见识/g' \
  -e 's/咸临丸是一艘荷兰造的军舰，日本人从来/咸临丸是一艘荷兰造的军舰。日本人从来/g' \
  "$FILE"
echo "   ✓ 超长句拆分完成"

# ==============================
# 第六步：引语标记统一
# ==============================
echo "🔧 Step 6: 引语标记统一..."
sed -i '' \
  -e 's/大意是：/大意是——/g' \
  -e 's/报纸……一个完全/报纸……，一个完全/g' \
  "$FILE"
echo "   ✓ 引语标记统一完成"

# ==============================
# 第七步：清理重复标点
# ==============================
echo "🔧 Step 7: 清理重复标点..."
sed -i '' \
  -e 's/、、/、/g' \
  -e 's/。。/。/g' \
  -e 's/，，/，/g' \
  "$FILE"
echo "   ✓ 重复标点清理完成"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ TTS断句修复完成！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "修复统计："
echo "• Step 1: 人名顿号清理（最严重问题）"
echo "• Step 2: 多音字标注清理"
echo "• Step 3: 年份格式统一"
echo "• Step 4: 数字量词分隔（~10处）"
echo "• Step 5: 超长句拆分（4处）"
echo "• Step 6: 引语标记统一（2处）"
echo "• Step 7: 重复标点清理"
echo ""
echo "文件对比："
echo "  原文备份: $BACKUP"
echo "  修复后: $FILE"
echo ""
echo "下一步："
echo "  1. 用 diff 检查修改: diff $BACKUP $FILE | head -50"
echo "  2. 重新生成音频: edge-tts --voice zh-CN-YunjianNeural --rate=+3% --pitch=-8Hz --text \"\$(cat $FILE)\" --write-media ${FILE%-tts.txt}.mp3"
